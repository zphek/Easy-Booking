#!/bin/bash
# .husky/pre-push

# Este script verifica si estamos haciendo push a ramas espec√≠ficas
# y ejecuta las pruebas solo en ese caso

# Lee la rama destino
while read local_ref local_sha remote_ref remote_sha
do
  # Extrae el nombre de la rama remota
  BRANCH_NAME=${remote_ref#refs/heads/}
  
  # Verifica si es una de las ramas objetivo
  if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "testing" || "$BRANCH_NAME" == "staging" ]]; then
    echo "üîç Push detectado a rama '$BRANCH_NAME'. Ejecutando pruebas..."
    
    # Ejecutar el entorno de desarrollo en segundo plano
    echo "üöÄ Iniciando el entorno de desarrollo..."
    npm run dev &
    DEV_PID=$!
    
    # Esperar a que el entorno de desarrollo est√© listo
    echo "‚è≥ Esperando a que el entorno de desarrollo est√© listo..."
    sleep 10
    
    # Ejecutar pruebas end-to-end
    echo "üß™ Ejecutando pruebas end-to-end..."
    npm run e2e
    E2E_STATUS=$?
    
    # Detener el entorno de desarrollo
    echo "üõë Deteniendo el entorno de desarrollo..."
    kill $DEV_PID
    
    # Esperar a que el proceso termine correctamente
    wait $DEV_PID 2>/dev/null || true
    
    # Verificar si las pruebas fueron exitosas
    if [ $E2E_STATUS -ne 0 ]; then
      echo "‚ùå Las pruebas end-to-end fallaron. Push a '$BRANCH_NAME' abortado."
      exit 1
    fi
    
    echo "‚úÖ Pruebas ejecutadas correctamente. Continuando con el push a '$BRANCH_NAME'."
  else
    echo "‚ÑπÔ∏è Push a rama '$BRANCH_NAME'. No se requieren pruebas."
  fi
done

exit 0